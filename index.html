<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transperth Tracker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .timeline {
            position: relative;
            width: 200px;
            margin: 40px auto;
            background: #f4f4f4;
            padding: 20px;
            border-radius: 10px;
        }
        .timeline::after {
            content: '';
            position: absolute;
            width: 6px;
            background-color: #ddd;
            top: 0;
            bottom: 0;
            left: 100%;
            margin-left: -3px;
        }
        .station {
            position: relative;
            width: 100%;
            padding: 10px;
            text-align: center;
            font-size: 16px;
            border-bottom: 1px solid #ddd;
        }
        .station:last-child {
            border-bottom: none;
        }
        .departures {
            position: absolute;
            width: 500px;
            top: 50%;
            transform: translateY(-50%);
        }
        .north {
            left: 110%;
        }
        .south {
            right: 110%;
            text-align: right;
        }
        .station-dot {
            position: absolute;
            top: 50%;
            left: 100%;
            height: 12px;
            width: 12px;
            background-color: #555;
            border: 2px solid #fff;
            transform: translate(-50%, -50%);
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <h1>Train Line Timeline</h1>
    <div id="timeline" class="timeline">
        
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            fetchData();
        });

        function fetchData() {
            fetch('/data')
                .then(response => response.text())
                .then(data => {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(data, "text/xml");
                    console.log(xmlDoc);
                    const stationsInfo = {};
    
                    const lineStationTrips = xmlDoc.getElementsByTagName('LineStationTrip');
                    Array.from(lineStationTrips).forEach(lineStationTrip => {
                        const stationTrips = lineStationTrip.getElementsByTagName('StationTrip');
    
                        Array.from(stationTrips).forEach(station => {
                            const stationName = station.getElementsByTagName('StationName')[0].textContent;
                            if (!stationsInfo[stationName]) {
                                stationsInfo[stationName] = { north: '', south: '' };
                            }
    
                            const trips = station.getElementsByTagName('Trip');
                            Array.from(trips).forEach(trip => {
                                const Ncar = trip.getElementsByTagName('Ncar')[0]?.textContent;
                                var State = trip.getElementsByTagName('State')[0]?.textContent;
                                const Destination = trip.getElementsByTagName('Destination')[0]?.textContent;
                                const RunPlatform = trip.getElementsByTagName('RunPlatform')[0]?.textContent;
    
                                if (State === 'Appr') {
                                    State = 'approaching';
                                } else if (State === 'Pred') {
                                    State = 'on other line. Currently at';
                                } else {
                                    State = 'standing at';
                                }
    
                                const tripInfo = `<p>${Ncar} car ${State} ${RunPlatform}. For ${Destination}</p>`;
                                
                                if (Destination === 'Mandurah' && lineStationTrip.getElementsByTagName('Outbound')[0].textContent === 'true') {
                                    stationsInfo[stationName].south += tripInfo;
                                } else if (Destination !== 'Mandurah' && lineStationTrip.getElementsByTagName('Outbound')[0].textContent === 'false') {
                                    stationsInfo[stationName].north += tripInfo;
                                }
                            });
                        });
                    });
    
                    const timeline = document.getElementById('timeline');
                    timeline.innerHTML = '';
                    Object.keys(stationsInfo).forEach(stationName => {
                        const stationDiv = document.createElement('div');
                        stationDiv.className = 'station';
                        stationDiv.innerHTML = `<div class="station-dot"></div><h3>${stationName}</h3>`;
    
                        const southDiv = document.createElement('div');
                        southDiv.className = 'departures south';
                        southDiv.innerHTML = stationsInfo[stationName].south;
                        stationDiv.appendChild(southDiv);
    
                        const northDiv = document.createElement('div');
                        northDiv.className = 'departures north';
                        northDiv.innerHTML = stationsInfo[stationName].north;
                        stationDiv.appendChild(northDiv);
    
                        timeline.appendChild(stationDiv);
                    });
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        setInterval(() => {
            fetchData();
        }, 2000);
    </script>       
</body>
</html>
